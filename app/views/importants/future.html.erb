<% content_for :title do %>
  未来降水
<% end %>

<%= render "tabbar"%>

<div class="searchbar">
  <form action="">
    <div id="r-result"><input type="text" placeholder="请输入您要查询的地址" id="suggestId"></div>
    <!-- <input type="submit" value="搜索" class="submit"> -->
    <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
  </form>
</div>

<div class="mapbar">
  <div id="allmap"></div>
</div>

<%= link_to "", class: "leida" do %>
  <%= image_tag("leida.png") %>
<% end %>

<div class="tipsContent">
  <div class="weather-info">
    <table>
      <tr>
        <th class="text-left">当前位置</th>
        <td id="address">上海市</td>
      </tr>
    </table>
    <table id="weather-info">
      <%= render partial: "rain_data", locals: {qpf_data: @qpf_data} %>
    </table>
  </div>
  <%= link_to "javascript:void(0);", class: "riskBtn" do %>
    <span>风险防范措施</span>
    <%= image_tag("hand.png")%>
  <% end -%>
</div>

<!-- 模态框 -->
<div class="modal-bg"></div>
<div class="modal-content">
  <div class="modal-title">风险预防措施</div>
  <div class="modal-body">
    <div class="text-center">内容未定</div>
  </div>
</div>

<% content_for :scripts do %>
  <%= javascript_include_tag baidu_api(ENV['baidukey']), 'data-turbolinks-track' => false %>
  <%= javascript_include_tag "http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js", 'data-turbolinks-track' => false %>
  <script type="text/javascript">
    $(function(){
      //初始化地图
      var map = new BMap.Map("allmap");
      var point = new BMap.Point(121.48,31.22);
      map.centerAndZoom(point, 11);  // 初始化地图,设置中心点坐标和地图级别
      map.enableScrollWheelZoom();  //开启鼠标滚轮缩放

      //地图第一步加载热力图
      var points = JSON.parse(gon.points);

      if(!isSupportCanvas()){
        alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
      }
      heatmapOverlay = new BMapLib.HeatmapOverlay({
        "radius":20,
        'opacity': 0.7,
        'gradient': {0.5:'#94a5cb', 0.8:'#5d79b7', 1:'#4463aa'}
      });
      map.addOverlay(heatmapOverlay);
      heatmapOverlay.setDataSet({data:points,max:1});
      //判断浏览区是否支持canvas
      function isSupportCanvas(){
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
      }

      //定位到当前位置
      // var mk;
      // var geolocation = new BMap.Geolocation();
      // geolocation.getCurrentPosition(function(r){
      //   if(this.getStatus() == BMAP_STATUS_SUCCESS){
      //     var mk = new BMap.Marker(r.point);
      //     map.addOverlay(mk);
      //     map.panTo(r.point);
      //     showInfo(r);  //自定定位并显示当前区域
      //   }
      //   else {
      //     alert('failed'+this.getStatus());
      //   }
      // },{enableHighAccuracy: true})

      //console.log(map.getOverlays());

      //获取点击位置的解析区域
      var gc = new BMap.Geocoder();
      function showInfo(e){
        var pt = e.point;
        gc.getLocation(pt, function(rs){
          var addComp = rs.addressComponents;
          map.clearOverlays();
          map.addOverlay(new BMap.Marker(pt));
          $("#address").text(addComp.district);
          $.ajax({
            type: "GET",
            url: "/importants/get_rain",
            data: {lng: e.point.lng, lat: e.point.lat}
          });
        });
      }
      map.addEventListener("click", showInfo);

      //搜索地址
      function G(id) {
        return document.getElementById(id);
      }
      var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
        {"input" : "suggestId"
        ,"location" : map
      });

      ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
      var str = "";
        var _value = e.fromitem.value;
        var value = "";
        if (e.fromitem.index > -1) {
          value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        }
        str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;
        value = "";
        if (e.toitem.index > -1) {
          _value = e.toitem.value;
          value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        }
        str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
        G("searchResultPanel").innerHTML = str;
      });

      var myValue;
      ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
      var _value = e.item.value;
        myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
        setPlace();
      });

      function setPlace(){
        map.clearOverlays();    //清除地图上所有覆盖物
        function myFun(){
          var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
          map.centerAndZoom(pp, 12);
          map.addOverlay(new BMap.Marker(pp));    //添加标注
          var inputVal = $("#suggestId").val();  //获取用户输入的值
          $("#address").text(inputVal);
        }
        var local = new BMap.LocalSearch(map, { //智能搜索
          onSearchComplete: myFun,
          renderOptions: {map: map}
        });
        local.search(myValue);
      }

      //地图的高度等于屏幕的高度
      var c_Height=($(document).height() - 171) + "px";
      $(".mapbar").css("height",c_Height);

      //风险防范措施按钮宽度等于降水信息宽度
      var b_width = $(".weather-info").width() + "px";
      $(".riskBtn").css("width", b_width);

      //风险防范措施模态框
      $(".riskBtn").click(function(e){
        $(".modal-bg").show(300);
        $(".modal-content").show(300);
        e.stopPropagation();
      });
      $('body').click(function(e){
        $(".modal-bg").hide();
        $(".modal-content").hide();
      });
    });
  </script>
<% end %>

<style type="text/css">
  .mapbar {
    height: 500px;
    width: 100%;
  }
  #allmap {
    width: 100%;
    height: 100%;
  }
</style>